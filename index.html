<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Quick Share Memo</title>
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* モバイルブラウザのセーフエリアと高さ調整 */
        :root {
            --sat: env(safe-area-inset-top);
            --sar: env(safe-area-inset-right);
            --sab: env(safe-area-inset-bottom);
            --sal: env(safe-area-inset-left);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            height: 100vh;
            height: 100dvh; /* モバイルのアドレスバー対策 */
            margin: 0;
            overflow: hidden;
            overscroll-behavior-y: none;
            background-color: #f3f4f6;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-width: 48rem; /* max-w-3xl */
            margin-left: auto;
            margin-right: auto;
            background-color: white;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            position: relative;
        }

        /* カスタムスクロールバー */
        textarea::-webkit-scrollbar {
            width: 6px;
        }
        textarea::-webkit-scrollbar-track {
            background: transparent;
        }
        textarea::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }

        /* モーダルアニメーション */
        .modal-overlay {
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease-out;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-box {
            transform: scale(0.95);
            transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .modal-overlay.active .modal-box {
            transform: scale(1);
        }

        /* フッターのセーフエリア対応 */
        .footer-safe {
            padding-bottom: calc(1rem + var(--sab));
        }

        /* フェードインアニメーション */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "react/": "https://esm.sh/react@^19.2.4/",
    "react": "https://esm.sh/react@^19.2.4",
    "lucide-react": "https://esm.sh/lucide-react@^0.563.0"
  }
}
</script>
</head>
<body>

    <div class="app-container">
        <!-- Header -->
        <header class="bg-white border-b border-gray-100 px-4 py-3 flex justify-between items-center z-10 shrink-0 shadow-sm">
            <h1 class="font-bold text-lg text-gray-700 flex items-center gap-2">
                <i class="fa-solid fa-pen-nib text-blue-500 text-xl"></i>
                <span>クイックシェア</span>
            </h1>
            <div class="flex items-center gap-1">
                <!-- 日記ボタン (新規追加) -->
                <button onclick="app.insertDiary()" class="text-gray-400 hover:text-emerald-500 hover:bg-emerald-50 transition-all p-2 rounded-full active:scale-90" title="日記テンプレートを挿入">
                    <i class="fa-solid fa-book text-lg"></i>
                </button>
                
                <!-- 日時ボタン -->
                <button onclick="app.insertTime()" class="text-gray-400 hover:text-blue-500 hover:bg-blue-50 transition-all p-2 rounded-full active:scale-90" title="日時を挿入">
                    <i class="fa-regular fa-clock text-xl"></i>
                </button>
                
                <div class="w-px h-4 bg-gray-300 mx-1"></div>
                <span id="charCount" class="text-[10px] text-gray-400 font-mono w-14 text-right">0文字</span>
                
                <!-- 削除ボタン -->
                <button onclick="app.openDeleteModal()" class="text-gray-400 hover:text-red-500 hover:bg-red-50 transition-all p-2 rounded-full ml-1 active:scale-90" title="削除">
                    <i class="fa-solid fa-trash-can text-lg"></i>
                </button>
            </div>
        </header>

        <!-- Main Area -->
        <main class="flex-1 overflow-hidden flex flex-col p-3 pb-1">
            <textarea 
                id="memoInput" 
                class="flex-1 w-full p-4 text-[17px] leading-relaxed bg-gray-50/50 rounded-2xl border border-gray-100 focus:border-blue-200 focus:bg-white focus:ring-4 focus:ring-blue-500/5 transition-all resize-none outline-none placeholder-gray-300"
                placeholder="ここに入力して即共有..."
                spellcheck="false"
            ></textarea>
        </main>

        <!-- Footer -->
        <footer class="bg-white border-t border-gray-100 p-4 footer-safe z-10 shrink-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
            <div class="grid grid-cols-5 gap-3">
                <button onclick="app.copyToClipboard()" class="col-span-2 bg-gray-100 hover:bg-gray-200 active:bg-gray-300 text-gray-700 font-bold py-3.5 rounded-2xl transition-all flex items-center justify-center gap-2 group active:scale-95">
                    <i class="fa-regular fa-copy group-active:scale-90 transition-transform text-lg"></i>
                    <span>コピー</span>
                </button>
                <button onclick="app.shareText()" class="col-span-3 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-blue-200 transition-all flex items-center justify-center gap-2 active:scale-95">
                    <i class="fa-solid fa-paper-plane text-lg"></i>
                    <span>共有する</span>
                </button>
            </div>
        </footer>

        <!-- Delete Confirmation Modal -->
        <div id="deleteModal" class="modal-overlay fixed inset-0 bg-black/50 backdrop-blur-[2px] z-[100] flex items-center justify-center p-6">
            <div class="modal-box bg-white rounded-2xl w-full max-w-xs p-6 shadow-2xl">
                <div class="flex justify-center mb-4">
                    <div class="h-12 w-12 rounded-full bg-red-100 flex items-center justify-center">
                        <i class="fa-solid fa-eraser text-red-600 text-2xl"></i>
                    </div>
                </div>
                <h3 class="text-lg font-bold text-gray-900 text-center mb-2">すべて消去しますか？</h3>
                <p class="text-sm text-gray-500 text-center mb-6 leading-relaxed">消去後、新しいタイムスタンプが自動で挿入されます。</p>
                <div class="flex gap-3">
                    <button onclick="app.closeDeleteModal()" class="flex-1 px-4 py-2.5 bg-gray-100 text-gray-700 rounded-xl font-semibold hover:bg-gray-200 transition-colors active:scale-95">
                        キャンセル
                    </button>
                    <button onclick="app.confirmDelete()" class="flex-1 px-4 py-2.5 bg-red-600 text-white rounded-xl font-semibold hover:bg-red-700 shadow-sm transition-colors active:scale-95">
                        消去して新規
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * アプリケーションロジック
         */
        const app = {
            STORAGE_KEY: 'quickShareMemo',
            dom: {},

            /**
             * 初期化処理
             */
            init() {
                // DOM要素のキャッシュ
                this.dom = {
                    memoInput: document.getElementById('memoInput'),
                    charCount: document.getElementById('charCount'),
                    deleteModal: document.getElementById('deleteModal')
                };

                // イベントリスナーの設定
                this.dom.memoInput.addEventListener('input', () => {
                    this.saveMemo();
                    this.updateCharCount();
                });

                // モーダル外クリックで閉じる
                this.dom.deleteModal.addEventListener('click', (e) => {
                    if (e.target === this.dom.deleteModal) this.closeDeleteModal();
                });

                // データのロード
                this.loadMemo();

                // iOS/Androidでのキーボード表示時のビューポート調整
                if (window.visualViewport) {
                    window.visualViewport.addEventListener('resize', () => {
                        document.body.style.height = window.visualViewport.height + 'px';
                        // スクロール位置を調整して入力欄が見えるようにする
                        window.scrollTo(0, 0);
                    });
                }
            },

            /**
             * 日時フォーマット生成
             * @returns {string} YYYY/MM/DD(Day) HH:mm
             */
            getFormattedDate() {
                const now = new Date();
                const days = ['日', '月', '火', '水', '木', '金', '土'];
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const date = String(now.getDate()).padStart(2, '0');
                const day = days[now.getDay()];
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                return `${year}/${month}/${date}(${day}) ${hours}:${minutes}`;
            },

            /**
             * メモの読み込み
             */
            loadMemo() {
                const saved = localStorage.getItem(this.STORAGE_KEY);
                if (saved) {
                    this.dom.memoInput.value = saved;
                } else {
                    this.resetWithTimestamp(false);
                }
                this.updateCharCount();
            },

            /**
             * メモの保存
             */
            saveMemo() {
                localStorage.setItem(this.STORAGE_KEY, this.dom.memoInput.value);
            },

            /**
             * 文字数カウントの更新
             */
            updateCharCount() {
                const count = this.dom.memoInput.value.length;
                this.dom.charCount.textContent = count + '文字';
            },

            /**
             * リセットしてタイムスタンプ挿入
             */
            resetWithTimestamp(shouldFocus = true) {
                const timestamp = this.getFormattedDate();
                const newText = timestamp + '\n';
                this.dom.memoInput.value = newText;
                this.saveMemo();
                this.updateCharCount();
                
                if (shouldFocus) {
                    // DOM更新後にフォーカスを当てるため少し待つ
                    setTimeout(() => {
                        this.dom.memoInput.focus();
                        this.dom.memoInput.setSelectionRange(newText.length, newText.length);
                    }, 0);
                }
            },

            /**
             * 共通テキスト挿入処理
             * @param {string} textToInsert 挿入するテキスト
             */
            insertTextAtCursor(textToInsert) {
                const input = this.dom.memoInput;
                const start = input.selectionStart;
                const end = input.selectionEnd;
                const currentText = input.value;

                // テキストを挿入（選択範囲があれば置換）
                const newText = currentText.substring(0, start) + textToInsert + currentText.substring(end);
                const newCursorPos = start + textToInsert.length;

                input.value = newText;
                this.saveMemo();
                this.updateCharCount();
                
                // フォーカスを戻してカーソル位置を更新
                setTimeout(() => {
                    input.focus();
                    input.setSelectionRange(newCursorPos, newCursorPos);
                }, 0);
            },

            /**
             * カーソル位置に日時を挿入
             */
            insertTime() {
                this.insertTextAtCursor(this.getFormattedDate());
            },

            /**
             * 日記テンプレートを挿入
             */
            insertDiary() {
                // 要望のテンプレート
                const template = '\n(1)今日の失敗・悪かったこと\n(2)嬉しかったこと・感動したこと\n(3)明日の目標\n';
                this.insertTextAtCursor(template);
            },

            /**
             * 削除確認モーダルを表示
             */
            openDeleteModal() {
                if (this.dom.memoInput.value.trim().length === 0) return;
                this.dom.deleteModal.classList.add('active');
            },

            /**
             * 削除確認モーダルを閉じる
             */
            closeDeleteModal() {
                this.dom.deleteModal.classList.remove('active');
            },

            /**
             * 削除実行
             */
            confirmDelete() {
                this.resetWithTimestamp(true);
                this.closeDeleteModal();
            },

            /**
             * クリップボードにコピー
             */
            async copyToClipboard() {
                const text = this.dom.memoInput.value;
                if (!text.trim()) return;

                try {
                    await navigator.clipboard.writeText(text);
                } catch (err) {
                    console.error('Failed to copy', err);
                }
            },

            /**
             * 共有機能（Web Share API）
             */
            async shareText() {
                const text = this.dom.memoInput.value;
                if (!text.trim()) {
                    this.dom.memoInput.focus();
                    return;
                }

                if (navigator.share) {
                    try {
                        await navigator.share({ text: text });
                    } catch (err) {
                        // AbortError等は無視
                    }
                } else {
                    // 非対応ブラウザの場合はコピーを実行
                    this.copyToClipboard();
                }
            }
        };

        // DOM構築完了後に初期化
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
